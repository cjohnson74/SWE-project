{% extends '_base.html' %}

{% load static %}

{% block title %}Courses Graph{% endblock %}

{% block content %}
<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        .bubble {
            fill: #4a90e2;  /* Calming blue color */
            stroke: #ffffff;
            stroke-width: 3px;
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.2));
        }
        .bubble:hover {
            fill: #357abd;
            filter: drop-shadow(0 3px 5px rgba(0, 0, 0, 0.3));
        }
        
        .assignment {
            fill: #f6b93b;  /* Warm yellow color */
            stroke: #ffffff;
            stroke-width: 2px;
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.2));
        }
        .assignment:hover {
            fill: #e59d1f;
            filter: drop-shadow(0 3px 5px rgba(0, 0, 0, 0.3));
        }
        
        .task {
            fill: #78e08f;  /* Soft green color */
            stroke: #ffffff;
            stroke-width: 2px;
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.2));
        }
        .task:hover {
            fill: #60b674;
            filter: drop-shadow(0 3px 5px rgba(0, 0, 0, 0.3));
        }
        
        .link {
            stroke: #b2bec3;
            stroke-width: 3px;
            stroke-dasharray: 5,5;  /* Creates a dashed line */
        }
        
        /* Custom tooltip styling */
        .custom-tooltip {
            background-color: #ffffff;
            border: 2px solid #dfe6e9;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            line-height: 1.4;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 300px;
            color: #2d3436;
        }
        
        .tooltip-title {
            font-weight: bold;
            color: #2d3436;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .tooltip-info {
            margin: 4px 0;
            display: flex;
            align-items: center;
        }
        
        .tooltip-icon {
            margin-right: 8px;
            color: #636e72;
        }
        
        /* Legend styling */
        .legend {
            position: fixed;
            top: 120px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        /* Instructions panel */
        .instructions {
            position: fixed;
            left: 20px;
            top: 120px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 300px;
        }
        
        /* Text label styling */
        .node-label {
            font-size: 14px;  /* Increased from 12px */
            font-weight: bold;
            text-anchor: middle;  /* Centers text horizontally */
            dominant-baseline: middle;  /* Centers text vertically */
            fill: #ffffff;
            pointer-events: none;  /* Makes text not interfere with clicks */
            user-select: none;  /* Prevents text selection */
        }
        
        /* Completion status styles */
        .assignment.completed {
            fill: #27ae60;  /* Green for completed */
        }
        .assignment.incomplete {
            fill: #f6b93b;  /* Original yellow for incomplete */
        }
        .assignment.overdue {
            fill: #e74c3c;  /* Red for overdue */
        }
        
        .task.completed {
            fill: #2ecc71;  /* Bright green for completed */
        }
        .task.incomplete {
            fill: #78e08f;  /* Original green for incomplete */
        }
        .task.overdue {
            fill: #ff7675;  /* Soft red for overdue */
        }
        
        /* Update legend to include completion status */
        .legend-section {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        
        .course-label {
            position: absolute;
            transform: translate(-50%, -50%);
            pointer-events: none;
            color: white;
            font-weight: bold;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
    </style>
</head>

<div class="container mt-4">
    <h1 class="text-center mb-4">Course Graph</h1>
    <svg id="graph" width="100%" height="600"></svg>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Pass the courses data from Django view
        console.log("HERE");
        const courses = {{ courses|safe }};
        console.log(courses);  // Log the courses data to check its structure

        // After the courses data is loaded
        console.log("Courses Data:", courses);

        courses.forEach(course => {
            console.log("\nCourse:", {
                name: course.name,
                course_code: course.course_code,
                assignments: course.assignments
            });
            
            if (course.assignments) {
                course.assignments.forEach(assignment => {
                    console.log("\nAssignment:", {
                        name: assignment.name,
                        due_at: assignment.due_at,
                        breakdowns: assignment.breakdowns
                    });
                    
                    if (assignment.breakdowns && assignment.breakdowns[0] && assignment.breakdowns[0].tasks) {
                        console.log("\nTasks:", assignment.breakdowns[0].tasks.map(task => ({
                            task_number: task.task_number,
                            description: task.description,
                            due_date: task.due_date,
                            estimated_time: task.estimated_time
                        })));
                    }
                });
            }
        });

        let svg = d3.select("#graph");
        let width = svg.node().getBoundingClientRect().width;
        console.log(width);
        let height = svg.node().getBoundingClientRect().height;
        console.log(height);

        // Calculate the center positions for the bubbles
        const bubbleRadius = 40; // Radius of the bubble
        const centerX = width / 2; // Center X position
        const centerY = height / 2; // Center Y position

        // Define scales for x and y positions
        const xScale = d3.scaleLinear()
            .domain([0, width]) // Adjust domain based on your data
            .range([0, width]); // Map to the width of the SVG

        const yScale = d3.scaleLinear()
            .domain([0, height]) // Adjust domain based on your data
            .range([height, 0]); // Invert y-axis for SVG

        // Define the drag behavior
        const drag = d3.drag()
            .on("start", dragstarted) // Called when drag starts
            .on("drag", dragged)       // Called during dragging
            .on("end", dragended);     // Called when drag ends

        function dragstarted(event, d) {
            d3.select(this).raise().classed("active", true); // Bring the dragged bubble to the front
        }

        function dragged(event, d) {
            d.x = event.x;
            d.y = event.y;

            // Update the dragged node position
            d3.select(this)
                .attr("cx", d.x)
                .attr("cy", d.y);

            if (d3.select(this).classed("bubble")) {
                // If this is a course being dragged
                if (d.visibleAssignments) {
                    d.visibleAssignments.forEach(assignment => {
                        // Calculate the new position for each assignment
                        // maintaining the same relative distance from the course
                        const dx = assignment.x - assignment.sourceCourse.x;
                        const dy = assignment.y - assignment.sourceCourse.y;
                        
                        // Update assignment position
                        assignment.x = d.x + dx;
                        assignment.y = d.y + dy;
                        
                        // Update the visual position of the assignment
                        d3.select(`circle.assignment[data-id="${assignment.id}"]`)
                            .attr("cx", assignment.x)
                            .attr("cy", assignment.y);

                        // Update the link
                        d3.select(assignment.link)
                            .attr("x1", d.x)
                            .attr("y1", d.y)
                            .attr("x2", assignment.x)
                            .attr("y2", assignment.y);
                    });

                    // Update the course's stored position
                    d.x = event.x;
                    d.y = event.y;
                }
            } else if (d3.select(this).classed("assignment")) {
                // If dragging an assignment, update its link
                d3.select(d.link)
                    .attr("x1", d.sourceCourse.x)
                    .attr("y1", d.sourceCourse.y)
                    .attr("x2", d.x)
                    .attr("y2", d.y);
            } else if (d3.select(this).classed("task")) {
                // Update the link coming TO this task
                d3.select(d.link)
                    .attr("x2", d.x)
                    .attr("y2", d.y);

                // Find and update any link going FROM this task
                const nextTask = d3.selectAll(".task")
                    .filter(task => task.source === d);
                
                if (!nextTask.empty()) {
                    d3.select(nextTask.datum().link)
                        .attr("x1", d.x)
                        .attr("y1", d.y);
                }
            }
        }

        function dragended(event, d) {
            d3.select(this).classed("active", false); // Remove the active class
        }

        // Add this right after your SVG creation to create a group for links that will always be behind nodes
        const linkGroup = svg.append("g").attr("class", "links");
        const nodeGroup = svg.append("g").attr("class", "nodes");

        // Create course nodes for each course
        const courseNodes = nodeGroup.selectAll(".bubble")
            .data(courses)
            .enter()
            .append("g")  // Create a group for each course
            .attr("class", "course-group");

        // Add the circle
        courseNodes.append("circle")
            .attr("class", "bubble")
            .attr("r", bubbleRadius)
            .attr("cx", d => width/2 + (Math.random() - 0.5) * 100)  // Random initial position
            .attr("cy", d => height/2 + (Math.random() - 0.5) * 100) // Random initial position
            .attr("data-toggle", "tooltip")
            .attr("title", d => `
                <div class="custom-tooltip">
                    <div class="tooltip-title">${d.name}</div>
                    <div class="tooltip-info">
                        <span class="tooltip-icon">📚</span> ${d.course_code}
                    </div>
                </div>
            `) // Tooltip content
            .on("click", function(event, d) {
                // Clear both assignments and tasks
                d3.selectAll(".assignment").remove();
                d3.selectAll(".task").remove();
                d3.selectAll(".link").remove();  // This will remove both assignment and task links
                
                // Show assignments for the clicked course
                showAssignments(d.assignments, d3.pointer(event), d);
            })
            .on("mouseover", function() {
                $(this).tooltip('show'); // Show tooltip on hover
            })
            .on("mouseout", function() {
                $(this).tooltip('hide'); // Hide tooltip on mouse out
            })
            .call(drag); // Attach the drag behavior to the bubbles

        // Replace the text label creation with this
        courseNodes.each(function(d) {
            // Create HTML label
            const label = document.createElement('div');
            label.className = 'course-label';
            label.textContent = d.course_code;
            document.body.appendChild(label);

            // Update label position when node moves
            d.label = label;
        });

        // Initialize Bootstrap tooltips
        $('[data-toggle="tooltip"]').tooltip({
            html: true, // Allow HTML content in tooltips
            trigger: 'hover'
        });

        // Modify the simulation
        simulation = d3.forceSimulation(courses)  // Initialize with courses data
            .force("charge", d3.forceManyBody().strength(-100))  // Increased repulsion
            .force("center", d3.forceCenter(width / 2, height / 2).strength(0.05))
            .force("collision", d3.forceCollide().radius(50))  // Prevent overlap
            .force("x", d3.forceX(width / 2).strength(0.1))   // Gentle force toward center x
            .force("y", d3.forceY(height / 2).strength(0.1))  // Gentle force toward center y
            .velocityDecay(0.7) // Add damping to slow down movement (0-1, higher = slower)
            .alphaDecay(0.02) // Slower cooling (smaller number = slower settling)
            .on("tick", ticked);

        

        // Update assignment creation to handle the data structure
        function showAssignments(assignments, position, sourceCourse) {
            console.log("Showing assignments for course:", sourceCourse);
            
            // Only remove assignments and links, not course labels
            d3.selectAll(".assignment").remove();
            d3.selectAll(".link").remove();
            
            // Store assignments with the course
            sourceCourse.visibleAssignments = assignments;
            console.log("Stored assignments:", sourceCourse.visibleAssignments);

            // Position assignments in a circle around the course
            assignments.forEach((assignment, i) => {
                const angle = (i / assignments.length) * 2 * Math.PI;
                const radius = 80;
                assignment.x = sourceCourse.x + radius * Math.cos(angle);
                assignment.y = sourceCourse.y + radius * Math.sin(angle);
                assignment.sourceCourse = sourceCourse;  // Store reference to parent course
                console.log(`Assignment ${i} position:`, {x: assignment.x, y: assignment.y});
            });

            // Create links first
            const links = linkGroup.selectAll(".link")
                .data(assignments)
                .enter()
                .append("line")
                .attr("class", "link");

            // Create assignment nodes
            const assignmentNodes = nodeGroup.selectAll(".assignment")
                .data(assignments)
                .enter()
                .append("circle")
                .attr("class", "assignment")
                .attr("data-id", d => d.id)
                .attr("class", d => {
                    const now = new Date();
                    const dueDate = new Date(d.due_at);
                    if (dueDate < now) return "assignment overdue";
                    return "assignment incomplete";
                })
                .attr("data-id", d => d.name)
                .attr("r", 20)
                .attr("cx", d => position[0] + 100)
                .attr("cy", d => position[1])
                .attr("data-toggle", "tooltip")
                .attr("title", d => `
                    <div class="custom-tooltip">
                        <div class="tooltip-title">${d.name}</div>
                        <div class="tooltip-info">
                            <span class="tooltip-icon">📅</span> Due: ${new Date(d.due_at).toLocaleDateString()}
                        </div>
                    </div>
                `)
                .on("click", function(event, d) {
                    // Clear existing tasks
                    d3.selectAll(".task").remove();
                    
                    // Clear ALL task-related links
                    d3.selectAll(".link")
                        .filter(l => {
                            // Remove links where:
                            // - either end is a task
                            // - or the link starts from any assignment
                            return l.source && (
                                l.source.constructor.name === 'Task' || 
                                l.source.task_number !== undefined ||
                                (l.target && l.target.task_number !== undefined) ||
                                l.source.breakdowns  // This identifies assignment sources
                            );
                        })
                        .remove();
                    
                    // Show tasks for the clicked assignment
                    if (d.breakdowns && d.breakdowns[0] && d.breakdowns[0].tasks) {
                        showTasks(d.breakdowns[0].tasks, d3.pointer(event), d);
                    }
                })
                .on("mouseover", function() {
                    $(this).tooltip('show');
                })
                .on("mouseout", function() {
                    $(this).tooltip('hide');
                })
                .call(drag);

            // Store references
            assignmentNodes.each(function(d, i) {
                d.link = links.nodes()[i];
                d.sourceCourse = sourceCourse;
            });

            // Update link positions
            links
                .attr("x1", sourceCourse.x)
                .attr("y1", sourceCourse.y)
                .attr("x2", d => position[0] + 100)
                .attr("y2", position[1]);

            // Update simulation with gentler forces
            simulation
                .nodes([...courses, ...assignments])
                .force("link", d3.forceLink().links(links)
                    .distance(80)  // Shorter target distance
                    .strength(0.2)) // Weaker link force
                .alpha(0.3) // Lower alpha for gentler start
                .restart();
        }

        // Update task creation to handle the data structure
        function showTasks(tasks, position, sourceAssignment) {
            console.log("Showing tasks for assignment:", sourceAssignment);
            d3.selectAll(".task").remove();
            d3.selectAll(".task-link").remove();
            
            // Store tasks with the assignment
            sourceAssignment.visibleTasks = tasks;
            
            // Sort tasks by task_number
            tasks.sort((a, b) => a.task_number - b.task_number);

            // Position tasks in a line extending from the assignment
            const taskSpacing = 40; // Spacing between tasks
            tasks.forEach((task, i) => {
                task.x = sourceAssignment.x + (i + 1) * taskSpacing;
                task.y = sourceAssignment.y;
                // Set the source based on position in chain
                task.source = i === 0 ? sourceAssignment : tasks[i - 1];
            });

            // Create links first (so they appear behind tasks)
            const links = linkGroup.selectAll(".task-link")
                .data(tasks)
                .enter()
                .append("line")
                .attr("class", "link")
                .attr("x1", d => d.source.x)  // Start from previous task or assignment
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.x)
                .attr("y2", d => d.y);

            // Create task nodes
            const taskNodes = nodeGroup.selectAll(".task")
                .data(tasks)
                .enter()
                .append("circle")
                .attr("class", "task")
                .attr("class", d => {
                    const now = new Date();
                    const dueDate = new Date(d.due_date);
                    if (dueDate < now) return "task overdue";
                    return "task incomplete";
                })
                .attr("data-id", d => d.task_number)
                .attr("r", 10)
                .attr("cx", d => d.x)
                .attr("cy", d => d.y)
                .attr("data-toggle", "tooltip")
                .attr("title", d => `
                    <div class="custom-tooltip">
                        <div class="tooltip-title">Task ${d.task_number}</div>
                        <div class="tooltip-info">
                            <span class="tooltip-icon">📝</span> ${d.description}
                        </div>
                        <div class="tooltip-info">
                            <span class="tooltip-icon">⏱️</span> ${d.estimated_time}
                        </div>
                        <div class="tooltip-info">
                            <span class="tooltip-icon">📅</span> Due: ${new Date(d.due_date).toLocaleDateString()}
                        </div>
                    </div>
                `)
                .on("mouseover", function() {
                    $(this).tooltip('show');
                })
                .on("mouseout", function() {
                    $(this).tooltip('hide');
                })
                .call(drag);

            // Store references
            taskNodes.each(function(d, i) {
                d.link = links.nodes()[i];
            });

            // Initialize tooltips
            $('[data-toggle="tooltip"]').tooltip({
                html: true,
                trigger: 'hover'
            });
        }

        // Function to update positions of nodes
        function ticked() {
            // Update links
            svg.selectAll(".link")
                .attr("x1", d => {
                    const source = d.sourceCourse || d.source;
                    return source.x;
                })
                .attr("y1", d => {
                    const source = d.sourceCourse || d.source;
                    return source.y;
                })
                .attr("x2", d => d.x)
                .attr("y2", d => d.y);

            // Update course groups
            const courseGroups = svg.selectAll(".course-group");
            courseGroups.selectAll("circle")
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);
            
            courseGroups.selectAll("text")
                .attr("x", d => d.x)
                .attr("y", d => d.y);

            // Update assignment positions
            svg.selectAll(".assignment")
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);

            // Update HTML labels
            courses.forEach(d => {
                if (d.label) {
                    const svgRect = svg.node().getBoundingClientRect();
                    d.label.style.left = (svgRect.left + d.x) + 'px';
                    d.label.style.top = (svgRect.top + d.y) + 'px';
                }
            });
        }

        // Start the simulation
        simulation.alpha(1).restart();

        // svg.append("rect")
        //     .attr("width", width || 0)
        //     .attr("height", height || 0)
            // .attr("fill", "lightgrey");
    });
</script>

<!-- Add legend and instructions -->
<div class="legend">
    <h4>Types</h4>
    <div class="legend-item">
        <div class="legend-color" style="background: #4a90e2;"></div>
        <span>Courses</span>
    </div>
    <div class="legend-section">
        <h5>Assignment Status</h5>
        <div class="legend-item">
            <div class="legend-color" style="background: #27ae60;"></div>
            <span>Completed</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f6b93b;"></div>
            <span>Incomplete</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #e74c3c;"></div>
            <span>Overdue</span>
        </div>
    </div>
    <div class="legend-section">
        <h5>Task Status</h5>
        <div class="legend-item">
            <div class="legend-color" style="background: #2ecc71;"></div>
            <span>Completed</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #78e08f;"></div>
            <span>Incomplete</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ff7675;"></div>
            <span>Overdue</span>
        </div>
    </div>
</div>

<div class="instructions">
    <h4>How to Use</h4>
    <ul>
        <li>Click on a course (blue) to see its assignments</li>
        <li>Click on an assignment (yellow) to see its tasks</li>
        <li>Drag any item to rearrange the view</li>
        <li>Hover over items for more information</li>
    </ul>
</div>
{% endblock %}
